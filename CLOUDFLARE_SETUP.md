# Инструкция по развертыванию Cloudflare Worker для Telegram-бота

## Предварительные требования

### 1. Получение Telegram Bot Token

Если у вас еще нет бота:

1. Откройте Telegram и найдите [@BotFather](https://t.me/botfather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям, задайте имя бота
4. Скопируйте токен (формат: `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`)
5. **ВАЖНО**: Сохраните токен в надежном месте!

### 2. Добавление бота в группу

1. Найдите вашего бота в Telegram
2. Добавьте его в группу с ID `-1003496210379`
3. Дайте боту права на отправку сообщений
4. Убедитесь, что бот не забанен в группе

### 3. Проверка chat_id

Чтобы убедиться, что chat_id правильный:

1. Добавьте бота в группу
2. Отправьте любое сообщение в группу
3. Откройте в браузере: `https://api.telegram.org/bot<ВАШ_ТОКЕН>/getUpdates`
4. Найдите в ответе поле `"chat":{"id": -1003496210379}` - это должен быть ваш chat_id

## Развертывание в Cloudflare

### Шаг 1: Создание Worker

1. Войдите в [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. Перейдите в **Workers & Pages**
3. Нажмите **Create Worker**
4. Задайте имя Worker: `olegweb-lead-to-telegram-api` (или убедитесь, что он уже создан с этим именем)
5. Нажмите **Deploy**

### Шаг 2: Добавление кода Worker

1. После создания Worker нажмите **Edit Code**
2. Удалите весь существующий код
3. Скопируйте код из файла `cloudflare-worker/worker.js` этого проекта
4. Вставьте в редактор Cloudflare
5. Нажмите **Save and Deploy**

### Шаг 3: Добавление секрета BOT_TOKEN

1. В настройках вашего Worker перейдите в **Settings** → **Variables**
2. В разделе **Environment Variables** нажмите **Add variable**
3. Выберите тип **Secret** (не Text!)
4. Введите:
   - **Variable name**: `BOT_TOKEN`
   - **Value**: ваш токен от BotFather
5. Нажмите **Encrypt**
6. Нажмите **Save and Deploy**

### Шаг 4: Проверка URL

1. В разделе **Settings** → **Triggers** проверьте URL вашего Worker
2. Он должен быть: `https://olegweb-lead-to-telegram-api.scorcioner.workers.dev`
3. Если отличается - обновите URL в файле `src/utils/telegram.js` проекта

## Тестирование

### Локальное тестирование

1. Откройте терминал в папке проекта:
   ```bash
   cd d:\Coding\WebOleg
   npm run dev
   ```

2. Откройте сайт в браузере (обычно http://localhost:5173)

3. Нажмите кнопку для открытия формы заявки

4. Заполните:
   - **Имя**: Тестовое имя
   - **Телефон**: +7 999 123-45-67
   - Поставьте галочку согласия

5. Нажмите **Отправить заявку**

### Проверка результатов

✅ **Успешная отправка**:
- На сайте появится зеленая галочка и текст "Заявка отправлена!"
- В Telegram-группе появится сообщение с данными формы

❌ **Если не работает**:

1. Откройте консоль браузера (F12) и проверьте ошибки
2. Проверьте логи Worker в Cloudflare Dashboard → Workers → выберите worker → Logs
3. Убедитесь, что:
   - BOT_TOKEN правильно добавлен в секреты
   - Бот добавлен в группу
   - chat_id правильный

## Возможные ошибки и решения

### "Failed to send message to Telegram"

**Причина**: Бот не может отправить сообщение в группу

**Решение**:
- Убедитесь, что бот добавлен в группу
- Проверьте, что бот не забанен
- Проверьте правильность chat_id

### "Server configuration error"

**Причина**: BOT_TOKEN не настроен

**Решение**:
- Добавьте BOT_TOKEN в Environment Variables (см. Шаг 3)
- Убедитесь, что выбрали тип **Secret**, а не Text

### "CORS error" в консоли браузера

**Причина**: Worker блокирует запросы с вашего домена

**Решение**:
- В коде worker.js измените строку:
  ```javascript
  'Access-Control-Allow-Origin': '*'
  ```
  на ваш конкретный домен, если это продакшен

### Worker не найден (404)

**Причина**: Неправильный URL или Worker не развернут

**Решение**:
- Проверьте URL в Cloudflare Dashboard
- Обновите `WORKER_URL` в файле `src/utils/telegram.js`

## Обновление кода Worker

Если нужно изменить код Worker:

1. Откройте Cloudflare Dashboard → Workers
2. Выберите ваш Worker
3. Нажмите **Edit Code**
4. Внесите изменения
5. Нажмите **Save and Deploy**

## Безопасность

⚠️ **ВАЖНО**:
- Никогда не публикуйте BOT_TOKEN в открытом виде
- Не коммитьте токен в Git
- Используйте только Environment Variables (Secrets) в Cloudflare
- В продакшене замените `'Access-Control-Allow-Origin': '*'` на ваш домен

## Поддержка

Если возникли проблемы:
1. Проверьте логи Worker в Cloudflare
2. Проверьте консоль браузера
3. Проверьте, что бот работает через Telegram API: 
   `https://api.telegram.org/bot<TOKEN>/getMe`

---

**Готово!** После выполнения всех шагов ваш сайт будет отправлять заявки в Telegram-группу.
